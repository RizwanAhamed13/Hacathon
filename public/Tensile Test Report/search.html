<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Tensile Test Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .back-button {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary back-button">← Back to Form</a>
        
        <div class="search-container">
            <h2 class="mb-4">Search Tensile Test Reports</h2>
            
            <div class="mb-3">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search across all columns...">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">Clear</button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table id="recordsTable" class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Item ID</th>
                            <th>Item Description</th>
                            <th>Heat No</th>
                            <th>Grade</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        // Use the same backend port as the main app
        const BACKEND_PORT = window.BACKEND_PORT || 3000;
        const BACKEND_URL = `http://localhost:${BACKEND_PORT}`;
        
        let dataTable;

        async function loadRecords() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/tensile-test-report`);
                if (!response.ok) throw new Error('Failed to fetch records');
                const data = await response.json();
                
                // Initialize DataTable if not already done
                if (!dataTable) {
                    // First, log the data to see what we're working with
                    console.log('Data received:', data);
                    
                    // Map the data to include only the fields we want to display
                    const displayData = data.map(item => ({
                        id: item.id,
                        test_date: item.test_date,
                        item: item.item || 'N/A',
                        heat_code: item.heat_code || 'N/A',
                        diameter_mm: item.diameter_mm ? Number(item.diameter_mm).toFixed(2) : 'N/A',
                        uts_n_mm2: item.uts_n_mm2 ? Number(item.uts_n_mm2).toFixed(2) : 'N/A',
                        created_at: item.created_at
                    }));
                    
                    dataTable = $('#recordsTable').DataTable({
                        data: displayData,
                        columns: [
                            { 
                                data: 'test_date',
                                title: 'Test Date',
                                render: function(data) {
                                    return data ? new Date(data).toLocaleDateString() : 'N/A';
                                }
                            },
                            { 
                                data: 'item',
                                title: 'Item',
                                defaultContent: 'N/A'
                            },
                            { 
                                data: 'heat_code',
                                title: 'Heat Code',
                                defaultContent: 'N/A'
                            },
                            { 
                                data: 'diameter_mm',
                                title: 'Diameter (mm)',
                                defaultContent: 'N/A'
                            },
                            { 
                                data: 'uts_n_mm2',
                                title: 'UTS (N/mm²)',
                                defaultContent: 'N/A'
                            },
                            {
                                data: null,
                                title: 'Actions',
                                orderable: false,
                                render: function(data, type, row) {
                                    return `<button class="btn btn-sm btn-primary view-details" data-id="${row.id}">View Details</button>`;
                                }
                            }
                        ],
                        pageLength: 10,
                        responsive: true,
                        order: [[0, 'desc']],
                        language: {
                            emptyTable: 'No test reports found',
                            zeroRecords: 'No matching records found'
                        }
                    });
                } else {
                    // Update existing DataTable
                    dataTable.clear().rows.add(data).draw();
                }
                
                // Add event listener for view details buttons
                $('.view-details').off('click').on('click', function() {
                    const id = $(this).data('id');
                    // Redirect to the main form with the ID to view details
                    window.location.href = `index.html?id=${id}`;
                });
                
            } catch (error) {
                console.error('Error loading records:', error);
                $('#records-tbody').html(`
                    <tr>
                        <td colspan="7" class="text-center text-danger py-3">
                            Error loading records. Please try again later.
                        </td>
                    </tr>
                `);
            }
        }

        // Search functionality
        $('#searchInput').on('keyup', function() {
            if (dataTable) {
                dataTable.search(this.value).draw();
            }
        });

        // Clear search
        $('#clearSearch').on('click', function() {
            $('#searchInput').val('').trigger('keyup');
        });

        // Load records when page loads
        $(document).ready(function() {
            loadRecords();
        });
    </script>
</body>
</html>
